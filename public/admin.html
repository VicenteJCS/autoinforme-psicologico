<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administración - Psicólogo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 1400px;
      width: 100%;
      padding: 40px;
      margin: 0 auto;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
    }

    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      color: #666;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 3px solid transparent;
    }

    .tab:hover {
      color: #667eea;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .button-small {
      padding: 8px 16px;
      font-size: 13px;
    }

    .button-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .button-secondary:hover {
      background: #e0e0e0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }

    input[type="email"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      font-family: inherit;
    }

    input[type="email"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    th {
      background: #f8f9fa;
      color: #333;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      color: #666;
      font-size: 14px;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 10px;
      padding: 30px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: #333;
      font-size: 20px;
    }

    .close-button {
      background: none;
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
    }

    .close-button:hover {
      color: #333;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-card h3 {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
    }

    .report-section {
      margin-bottom: 30px;
    }

    .report-section h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .report-section p {
      color: #666;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .score-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .score-card h4 {
      color: #333;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .score-bar {
      background: #e0e0e0;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .score-fill {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      transition: width 0.3s;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Panel de Administración</h1>
    <p class="subtitle">Gestión de pacientes y evaluaciones</p>

    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="tab" onclick="switchTab('invitations')">Invitaciones</button>
      <button class="tab" onclick="switchTab('assessments')">Evaluaciones</button>
    </div>

    <!-- TAB: DASHBOARD -->
    <div class="tab-content active" id="tab-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Invitaciones</h3>
          <div class="value" id="totalInvitations">0</div>
        </div>
        <div class="stat-card">
          <h3>Invitaciones Usadas</h3>
          <div class="value" id="usedInvitations">0</div>
        </div>
        <div class="stat-card">
          <h3>Evaluaciones Completadas</h3>
          <div class="value" id="completedAssessments">0</div>
        </div>
        <div class="stat-card">
          <h3>Evaluaciones Pendientes</h3>
          <div class="value" id="pendingAssessments">0</div>
        </div>
      </div>

      <h2 style="margin-bottom: 20px; color: #333;">Últimas Evaluaciones</h2>
      <div id="recentAssessments"></div>
    </div>

    <!-- TAB: INVITACIONES -->
    <div class="tab-content" id="tab-invitations">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #333;">Gestión de Invitaciones</h2>
        <button class="button" onclick="showCreateInvitationModal()">+ Nueva Invitación</button>
      </div>

      <div class="loading" id="invitationsLoading">
        <div class="spinner"></div>
        <p>Cargando invitaciones...</p>
      </div>

      <div id="invitationsTable"></div>
    </div>

    <!-- TAB: EVALUACIONES -->
    <div class="tab-content" id="tab-assessments">
      <h2 style="margin-bottom: 20px; color: #333;">Todas las Evaluaciones</h2>

      <div class="loading" id="assessmentsLoading">
        <div class="spinner"></div>
        <p>Cargando evaluaciones...</p>
      </div>

      <div id="assessmentsTable"></div>
    </div>
  </div>

  <!-- MODAL: CREAR INVITACIÓN -->
  <div class="modal" id="createInvitationModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Nueva Invitación</h2>
        <button class="close-button" onclick="closeModal('createInvitationModal')">&times;</button>
      </div>

      <div class="form-group">
        <label for="invitationEmail">Email del Paciente</label>
        <input type="email" id="invitationEmail" placeholder="paciente@email.com" required>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="button" onclick="createInvitation()">Crear Invitación</button>
        <button class="button button-secondary" onclick="closeModal('createInvitationModal')">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: VER EVALUACIÓN -->
  <div class="modal" id="viewAssessmentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Detalles de la Evaluación</h2>
        <button class="close-button" onclick="closeModal('viewAssessmentModal')">&times;</button>
      </div>

      <div id="assessmentDetails"></div>

      <div style="margin-top: 20px;">
        <button class="button button-secondary" onclick="closeModal('viewAssessmentModal')">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: LINK DE INVITACIÓN -->
  <div class="modal" id="invitationLinkModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Invitación Creada</h2>
        <button class="close-button" onclick="closeModal('invitationLinkModal')">&times;</button>
      </div>

      <p style="margin-bottom: 15px; color: #666;">Comparte este enlace con el paciente:</p>
      <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px; word-break: break-all;">
        <strong id="invitationLink"></strong>
      </div>

      <div style="display: flex; gap: 10px;">
        <button class="button" onclick="copyInvitationLink()">Copiar Enlace</button>
        <button class="button button-secondary" onclick="closeModal('invitationLinkModal')">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    let currentInvitationLink = '';

    // Cargar datos al inicio
    window.onload = function() {
      loadDashboard();
      loadInvitations();
      loadAssessments();
    };

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');

      if (tabName === 'dashboard') loadDashboard();
      if (tabName === 'invitations') loadInvitations();
      if (tabName === 'assessments') loadAssessments();
    }

    async function loadDashboard() {
      try {
        const [invitations, assessments] = await Promise.all([
          fetch('/api/admin/invitations').then(r => r.json()),
          fetch('/api/admin/assessments').then(r => r.json())
        ]);

        const usedInvitations = invitations.filter(i => i.used).length;
        const completedAssessments = assessments.filter(a => a.completed).length;
        const pendingAssessments = assessments.filter(a => !a.completed).length;

        document.getElementById('totalInvitations').textContent = invitations.length;
        document.getElementById('usedInvitations').textContent = usedInvitations;
        document.getElementById('completedAssessments').textContent = completedAssessments;
        document.getElementById('pendingAssessments').textContent = pendingAssessments;

        // Mostrar últimas evaluaciones
        const recent = assessments.slice(0, 5);
        let html = '';
        
        if (recent.length === 0) {
          html = '<div class="empty-state"><p>No hay evaluaciones todavía</p></div>';
        } else {
          html = '<table><thead><tr><th>Paciente</th><th>Fecha</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
          recent.forEach(a => {
            const date = new Date(a.created_at).toLocaleDateString('es-ES');
            const status = a.completed ? '<span class="badge badge-success">Completada</span>' : '<span class="badge badge-warning">Pendiente</span>';
            html += `
              <tr>
                <td>${a.patient_name || 'Sin nombre'}</td>
                <td>${date}</td>
                <td>${status}</td>
                <td><button class="button button-small" onclick="viewAssessment('${a.id}')">Ver Detalles</button></td>
              </tr>
            `;
          });
          html += '</tbody></table>';
        }
        
        document.getElementById('recentAssessments').innerHTML = html;
      } catch (error) {
        showError('Error al cargar el dashboard');
      }
    }

    async function loadInvitations() {
      document.getElementById('invitationsLoading').style.display = 'block';
      
      try {
        const response = await fetch('/api/admin/invitations');
        const invitations = await response.json();

        let html = '';
        
        if (invitations.length === 0) {
          html = '<div class="empty-state"><p>No hay invitaciones todavía. Crea una nueva para comenzar.</p></div>';
        } else {
          html = '<table><thead><tr><th>Email</th><th>Fecha Creación</th><th>Estado</th><th>Token</th></tr></thead><tbody>';
          invitations.forEach(inv => {
            const date = new Date(inv.created_at).toLocaleDateString('es-ES');
            const status = inv.used ? '<span class="badge badge-success">Usada</span>' : '<span class="badge badge-info">Pendiente</span>';
            html += `
              <tr>
                <td>${inv.email}</td>
                <td>${date}</td>
                <td>${status}</td>
                <td style="font-family: monospace; font-size: 12px;">${inv.token.substring(0, 8)}...</td>
              </tr>
            `;
          });
          html += '</tbody></table>';
        }
        
        document.getElementById('invitationsTable').innerHTML = html;
      } catch (error) {
        showError('Error al cargar invitaciones');
      } finally {
        document.getElementById('invitationsLoading').style.display = 'none';
      }
    }

    async function loadAssessments() {
      document.getElementById('assessmentsLoading').style.display = 'block';
      
      try {
        const response = await fetch('/api/admin/assessments');
        const assessments = await response.json();

        let html = '';
        
        if (assessments.length === 0) {
          html = '<div class="empty-state"><p>No hay evaluaciones todavía</p></div>';
        } else {
          html = '<table><thead><tr><th>Paciente</th><th>Email</th><th>Edad</th><th>Fecha</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
          assessments.forEach(a => {
            const date = new Date(a.created_at).toLocaleDateString('es-ES');
            const status = a.completed ? '<span class="badge badge-success">Completada</span>' : '<span class="badge badge-warning">Pendiente</span>';
            html += `
              <tr>
                <td>${a.patient_name || 'Sin nombre'}</td>
                <td>${a.email || 'No especificado'}</td>
                <td>${a.age || '-'}</td>
                <td>${date}</td>
                <td>${status}</td>
                <td><button class="button button-small" onclick="viewAssessment('${a.id}')">Ver Detalles</button></td>
              </tr>
            `;
          });
          html += '</tbody></table>';
        }
        
        document.getElementById('assessmentsTable').innerHTML = html;
      } catch (error) {
        showError('Error al cargar evaluaciones');
      } finally {
        document.getElementById('assessmentsLoading').style.display = 'none';
      }
    }

    async function viewAssessment(assessmentId) {
      try {
        const [assessment, scores] = await Promise.all([
          fetch(`/api/assessments/${assessmentId}`).then(r => r.json()),
          fetch(`/api/scores/${assessmentId}`).then(r => r.json())
        ]);

        let html = `
          <div class="report-section">
            <h3>Datos del Paciente</h3>
            <p><strong>Nombre:</strong> ${assessment.patient_name || 'No especificado'}</p>
            <p><strong>Edad:</strong> ${assessment.age || 'No especificado'}</p>
            <p><strong>Género:</strong> ${assessment.gender || 'No especificado'}</p>
            <p><strong>Estado Civil:</strong> ${assessment.marital_status || 'No especificado'}</p>
            <p><strong>Ocupación:</strong> ${assessment.occupation || 'No especificado'}</p>
            <p><strong>Email:</strong> ${assessment.email || 'No especificado'}</p>
          </div>

          <div class="report-section">
            <h3>Motivo de Consulta</h3>
            <p>${assessment.consultation_reason || 'No especificado'}</p>
          </div>

          <div class="report-section">
            <h3>Datos Médicos</h3>
            <p><strong>Medicamentos:</strong> ${assessment.medications || 'Ninguno'}</p>
            <p><strong>Antecedentes Médicos:</strong> ${assessment.medical_history || 'Ninguno'}</p>
            <p><strong>Alergias:</strong> ${assessment.allergies || 'Ninguna'}</p>
            <p><strong>Traumas:</strong> ${assessment.traumas || 'Ninguno'}</p>
          </div>

          <div class="report-section">
            <h3>Estilo de Vida</h3>
            <p><strong>Alimentación:</strong> ${assessment.diet || 'No especificado'}</p>
            <p><strong>Ejercicio:</strong> ${assessment.exercise || 'No especificado'}</p>
            <p><strong>Suplementos:</strong> ${assessment.supplements || 'Ninguno'}</p>
          </div>
        `;

        if (scores.length > 0) {
          html += '<div class="report-section"><h3>Resultados de Cuestionarios</h3>';
          scores.forEach(score => {
            const percentage = parseFloat(score.percentage);
            html += `
              <div class="score-card">
                <h4>${score.questionnaire_id}</h4>
                <div class="score-bar">
                  <div class="score-fill" style="width: ${percentage}%"></div>
                </div>
                <p><strong>Puntuación:</strong> ${score.total_score}/${score.max_score} (${percentage.toFixed(1)}%)</p>
                <p><strong>Interpretación:</strong> ${score.interpretation}</p>
              </div>
            `;
          });
          html += '</div>';
        } else {
          html += '<div class="report-section"><p>No hay resultados de cuestionarios todavía.</p></div>';
        }

        document.getElementById('assessmentDetails').innerHTML = html;
        openModal('viewAssessmentModal');
      } catch (error) {
        showError('Error al cargar los detalles de la evaluación');
      }
    }

    function showCreateInvitationModal() {
      document.getElementById('invitationEmail').value = '';
      openModal('createInvitationModal');
    }

    async function createInvitation() {
      const email = document.getElementById('invitationEmail').value;
      
      if (!email) {
        showError('Por favor ingresa un email');
        return;
      }

      try {
        const response = await fetch('/api/invitations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const data = await response.json();

        if (response.ok) {
          currentInvitationLink = data.link;
          document.getElementById('invitationLink').textContent = data.link;
          closeModal('createInvitationModal');
          openModal('invitationLinkModal');
          loadInvitations();
          loadDashboard();
        } else {
          showError(data.error || 'Error al crear invitación');
        }
      } catch (error) {
        showError('Error al crear invitación');
      }
    }

    function copyInvitationLink() {
      navigator.clipboard.writeText(currentInvitationLink).then(() => {
        showSuccess('Enlace copiado al portapapeles');
      }).catch(() => {
        showError('No se pudo copiar el enlace');
      });
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function showSuccess(message) {
      const el = document.getElementById('successMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }
  </script>
</body>
</html>

