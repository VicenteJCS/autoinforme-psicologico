<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autoinforme Psicológico</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 800px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }

    input[type="text"],
    input[type="email"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .checkbox-group {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      margin-bottom: 0;
      cursor: pointer;
    }

    .checkbox-group input[type="checkbox"] {
      margin-right: 8px;
      cursor: pointer;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      margin-bottom: 0;
      cursor: pointer;
    }

    .radio-group input[type="radio"] {
      margin-right: 8px;
      cursor: pointer;
    }

    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .button-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .button-secondary:hover {
      background: #e0e0e0;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .progress-bar {
      background: #f0f0f0;
      height: 4px;
      border-radius: 2px;
      margin-bottom: 30px;
      overflow: hidden;
    }

    .progress-fill {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      transition: width 0.3s;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }

    .button-group button {
      flex: 1;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .scale-options {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .scale-option {
      flex: 1;
      min-width: 80px;
    }

    .scale-option input[type="radio"] {
      display: none;
    }

    .scale-option label {
      display: block;
      padding: 10px;
      text-align: center;
      border: 2px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 0;
    }

    .scale-option input[type="radio"]:checked + label {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .question-number {
      color: #999;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .section-title {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 18px;
    }

    .conditional-field {
      display: none;
      margin-left: 20px;
      padding-left: 20px;
      border-left: 3px solid #ddd;
    }

    .conditional-field.visible {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Autoinforme Psicológico</h1>
    <p class="subtitle">Evaluación confidencial de tu bienestar emocional</p>

    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Procesando...</p>
    </div>

    <!-- SECCIÓN 1: VALIDACIÓN DE TOKEN -->
    <div class="section active" id="section-token">
      <h2 class="section-title">Validación de Acceso</h2>
      <p style="margin-bottom: 20px; color: #666;">Por favor, ingresa tu email para acceder a la evaluación.</p>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="tu@email.com" required>
      </div>
      <button class="button" onclick="validateToken()">Continuar</button>
    </div>

    <!-- SECCIÓN 2: DATOS DESCRIPTIVOS Y MÉDICOS -->
    <div class="section" id="section-data">
      <h2 class="section-title">Información Personal y Médica</h2>

      <h3 style="margin-top: 20px; margin-bottom: 15px; color: #333; font-size: 16px;">Datos Descriptivos</h3>

      <div class="form-group">
        <label for="patientName">Nombre Completo</label>
        <input type="text" id="patientName" placeholder="Tu nombre" required>
      </div>

      <div class="form-group">
        <label for="age">Edad</label>
        <input type="number" id="age" placeholder="Ej: 30" min="18" max="120" required>
      </div>

      <div class="form-group">
        <label for="gender">Género</label>
        <select id="gender" required>
          <option value="">Selecciona una opción</option>
          <option value="male">Masculino</option>
          <option value="female">Femenino</option>
          <option value="other">Otro</option>
        </select>
      </div>

      <div class="form-group">
        <label for="maritalStatus">Estado Civil</label>
        <input type="text" id="maritalStatus" placeholder="Soltero/a, Casado/a, etc.">
      </div>

      <div class="form-group">
        <label for="occupation">Ocupación</label>
        <input type="text" id="occupation" placeholder="Tu profesión o actividad">
      </div>

      <div class="form-group">
        <label for="consultationReason">Motivo de Consulta</label>
        <textarea id="consultationReason" placeholder="¿Por qué buscas esta evaluación?" required></textarea>
      </div>

      <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333; font-size: 16px;">Datos Médicos y Estilo de Vida</h3>

      <div class="form-group">
        <label for="medications">Medicamentos Actuales</label>
        <textarea id="medications" placeholder="Nombre, dosis y motivo de cada medicamento (si aplica)"></textarea>
      </div>

      <div class="form-group">
        <label for="medicalHistory">Antecedentes Médicos</label>
        <textarea id="medicalHistory" placeholder="Enfermedades crónicas, hospitalizaciones, operaciones (si aplica)"></textarea>
      </div>

      <div class="form-group">
        <label for="allergies">Alergias e Intolerancias</label>
        <textarea id="allergies" placeholder="Alergias alimentarias, medicamentosas o ambientales (si aplica)"></textarea>
      </div>

      <div class="form-group">
        <label for="traumas">Experiencias Traumáticas o Estresantes</label>
        <textarea id="traumas" placeholder="Accidentes, pérdidas, abusos, violencia u otras experiencias de alto impacto emocional (si aplica)"></textarea>
      </div>

      <div class="form-group">
        <label for="diet">Alimentación</label>
        <textarea id="diet" placeholder="Describe cómo sueles alimentarte en un día típico (horarios, cantidad, tipos de alimentos)"></textarea>
      </div>

      <div class="form-group">
        <label>¿Realizas actividad física o deportiva con regularidad?</label>
        <div class="checkbox-group">
          <label><input type="checkbox" id="exerciseYes" onchange="toggleExerciseDetails()"> Sí</label>
          <label><input type="checkbox" id="exerciseNo" onchange="toggleExerciseDetails()"> No</label>
        </div>
        <div class="conditional-field" id="exerciseDetails">
          <div class="form-group">
            <label for="exerciseType">Tipo de Actividad</label>
            <input type="text" id="exerciseType" placeholder="Ej: Correr, Yoga, Natación">
          </div>
          <div class="form-group">
            <label for="exerciseFrequency">Frecuencia</label>
            <input type="text" id="exerciseFrequency" placeholder="Ej: 3 veces por semana">
          </div>
          <div class="form-group">
            <label for="exerciseDuration">Duración Media por Sesión</label>
            <input type="text" id="exerciseDuration" placeholder="Ej: 45 minutos">
          </div>
          <div class="form-group">
            <label>Intensidad</label>
            <div class="radio-group">
              <label><input type="radio" name="exerciseIntensity" value="low"> Baja</label>
              <label><input type="radio" name="exerciseIntensity" value="medium"> Media</label>
              <label><input type="radio" name="exerciseIntensity" value="high"> Alta</label>
            </div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="supplements">Suplementación</label>
        <textarea id="supplements" placeholder="Vitaminas, minerales, proteínas u otros suplementos que tomes (si aplica)"></textarea>
      </div>

      <div class="form-group">
        <label>¿Dispones de analíticas recientes o informes médicos?</label>
        <div class="checkbox-group">
          <label><input type="checkbox" id="analyticsYes" onchange="toggleAnalyticsDetails()"> Sí</label>
          <label><input type="checkbox" id="analyticsNo" onchange="toggleAnalyticsDetails()"> No</label>
        </div>
        <div class="conditional-field" id="analyticsDetails">
          <div class="form-group">
            <label for="analyticsContent">Resultados Relevantes</label>
            <textarea id="analyticsContent" placeholder="Describe brevemente los resultados más relevantes"></textarea>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button class="button button-secondary" onclick="goBack()">Atrás</button>
        <button class="button" onclick="startQuestionnaires()">Continuar a Cuestionarios</button>
      </div>
    </div>

    <!-- SECCIÓN 3: CUESTIONARIOS -->
    <div class="section" id="section-questionnaires">
      <h2 class="section-title" id="questionnaireTitle">Sección 1 de 7</h2>
      <p style="margin-bottom: 20px; color: #666;" id="questionnaireInstructions"></p>
      <div id="questionsContainer"></div>
      <div class="button-group">
        <button class="button button-secondary" id="prevBtn" onclick="previousQuestionnaire()" style="display: none;">Anterior</button>
        <button class="button" id="nextBtn" onclick="nextQuestionnaire()">Siguiente</button>
      </div>
    </div>

    <!-- SECCIÓN 4: RESULTADOS -->
    <div class="section" id="section-results">
      <h2 class="section-title">Resultados de tu Evaluación</h2>
      <div id="resultsContainer"></div>
      <div class="button-group">
        <button class="button" onclick="downloadReport()">Descargar Informe</button>
      </div>
    </div>
  </div>

  <script>
    let currentToken = null;
    let currentAssessmentId = null;
    let questionnaires = [];
    let currentQuestionnaireIndex = 0;
    let answers = {};

    async function validateToken() {
      const email = document.getElementById('email').value;
      if (!email) {
        showError('Por favor ingresa tu email');
        return;
      }

      // Aquí simplemente guardamos el email, no validamos un token
      // En una versión real, validarías contra una invitación
      currentToken = email;
      showSection('section-data');
      updateProgress(1);
    }

    function toggleExerciseDetails() {
      const yes = document.getElementById('exerciseYes').checked;
      const no = document.getElementById('exerciseNo').checked;
      const details = document.getElementById('exerciseDetails');
      
      if (yes) {
        document.getElementById('exerciseNo').checked = false;
        details.classList.add('visible');
      } else if (!no) {
        details.classList.remove('visible');
      }
    }

    function toggleAnalyticsDetails() {
      const yes = document.getElementById('analyticsYes').checked;
      const no = document.getElementById('analyticsNo').checked;
      const details = document.getElementById('analyticsDetails');
      
      if (yes) {
        document.getElementById('analyticsNo').checked = false;
        details.classList.add('visible');
      } else if (!no) {
        details.classList.remove('visible');
      }
    }

    async function startQuestionnaires() {
      const patientName = document.getElementById('patientName').value;
      const age = document.getElementById('age').value;
      const gender = document.getElementById('gender').value;
      const maritalStatus = document.getElementById('maritalStatus').value;
      const occupation = document.getElementById('occupation').value;
      const consultationReason = document.getElementById('consultationReason').value;
      const medications = document.getElementById('medications').value;
      const medicalHistory = document.getElementById('medicalHistory').value;
      const allergies = document.getElementById('allergies').value;
      const traumas = document.getElementById('traumas').value;
      const diet = document.getElementById('diet').value;
      const exercise = `${document.getElementById('exerciseYes').checked ? 'Sí - ' : 'No'}${document.getElementById('exerciseType').value ? document.getElementById('exerciseType').value : ''}`;
      const supplements = document.getElementById('supplements').value;
      const analytics = document.getElementById('analyticsContent').value;

      if (!patientName || !age || !gender || !consultationReason) {
        showError('Por favor completa todos los campos requeridos');
        return;
      }

      showLoading(true);

      try {
        const response = await fetch('/api/assessments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token: currentToken,
            patient_name: patientName,
            age: parseInt(age),
            gender,
            marital_status: maritalStatus,
            occupation,
            email: currentToken,
            consultation_reason: consultationReason,
            medications,
            medical_history: medicalHistory,
            allergies,
            traumas,
            diet,
            exercise,
            supplements,
            analytics
          })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        currentAssessmentId = data.id;
        answers = {};

        const questRes = await fetch('/api/questionnaires');
        questionnaires = await questRes.json();

        currentQuestionnaireIndex = 0;
        showQuestionnaire();
        showSection('section-questionnaires');
        updateProgress(2);
      } catch (error) {
        showError('Error: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    function showQuestionnaire() {
      const q = questionnaires[currentQuestionnaireIndex];
      document.getElementById('questionnaireTitle').textContent = `Sección ${currentQuestionnaireIndex + 1} de ${questionnaires.length}`;
      document.getElementById('questionnaireInstructions').textContent = 'Por favor, responde las siguientes preguntas de forma honesta.';

      let html = '';
      q.questions.forEach((question, index) => {
        const scale = q.scale;
        html += `
          <div class="form-group">
            <div class="question-number">Pregunta ${index + 1} de ${q.questions.length}</div>
            <label>${question}</label>
            <div class="scale-options">
        `;
        for (let i = scale.min; i <= scale.max; i++) {
          const label = scale.labels[i - scale.min];
          const key = `${q.id}-${index}`;
          html += `
            <div class="scale-option">
              <input type="radio" id="${key}-${i}" name="${key}" value="${i}" onchange="recordAnswer('${q.id}', ${index}, ${i})">
              <label for="${key}-${i}">${label}</label>
            </div>
          `;
        }
        html += `</div></div>`;
      });

      document.getElementById('questionsContainer').innerHTML = html;

      // Restaurar respuestas previas
      if (answers[q.id]) {
        answers[q.id].forEach((value, index) => {
          const key = `${q.id}-${index}-${value}`;
          const element = document.getElementById(key);
          if (element) element.checked = true;
        });
      }

      document.getElementById('prevBtn').style.display = currentQuestionnaireIndex > 0 ? 'block' : 'none';
      document.getElementById('nextBtn').textContent = currentQuestionnaireIndex === questionnaires.length - 1 ? 'Finalizar' : 'Siguiente';
    }

    function recordAnswer(questionnaireId, questionIndex, value) {
      if (!answers[questionnaireId]) {
        answers[questionnaireId] = [];
      }
      answers[questionnaireId][questionIndex] = value;
    }

    async function nextQuestionnaire() {
      const q = questionnaires[currentQuestionnaireIndex];
      const answered = answers[q.id] && answers[q.id].length === q.questions.length;

      if (!answered) {
        showError('Por favor responde todas las preguntas');
        return;
      }

      if (currentQuestionnaireIndex === questionnaires.length - 1) {
        await finishQuestionnaires();
      } else {
        currentQuestionnaireIndex++;
        showQuestionnaire();
        updateProgress(2 + (currentQuestionnaireIndex / questionnaires.length));
      }
    }

    function previousQuestionnaire() {
      if (currentQuestionnaireIndex > 0) {
        currentQuestionnaireIndex--;
        showQuestionnaire();
        updateProgress(2 + (currentQuestionnaireIndex / questionnaires.length));
      }
    }

    async function finishQuestionnaires() {
      showLoading(true);

      try {
        const answersList = [];
        Object.entries(answers).forEach(([qId, values]) => {
          values.forEach((value, index) => {
            answersList.push({
              questionnaireId: qId,
              questionId: index,
              value
            });
          });
        });

        await fetch('/api/answers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            assessmentId: currentAssessmentId,
            answers: answersList
          })
        });

        const scoresRes = await fetch('/api/calculate-scores', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ assessmentId: currentAssessmentId })
        });

        const scores = await scoresRes.json();

        const reportRes = await fetch('/api/generate-report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ assessmentId: currentAssessmentId })
        });

        const report = await reportRes.json();

        displayResults(scores);
        showSection('section-results');
        updateProgress(4);
      } catch (error) {
        showError('Error: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    function displayResults(scores) {
      let html = '<div style="background: #f9f9f9; padding: 20px; border-radius: 5px;">';
      scores.forEach(score => {
        html += `
          <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #ddd;">
            <h3 style="color: #667eea; margin-bottom: 10px;">${score.questionnaireId}</h3>
            <p><strong>Puntuación:</strong> ${score.totalScore}/${score.maxScore}</p>
            <p><strong>Porcentaje:</strong> ${score.percentage}%</p>
            <p><strong>Interpretación:</strong> ${score.interpretation}</p>
          </div>
        `;
      });
      html += '</div>';
      document.getElementById('resultsContainer').innerHTML = html;
    }

    function downloadReport() {
      alert('La descarga del informe estará disponible próximamente. Tu evaluación ha sido guardada.');
    }

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
    }

    function updateProgress(step) {
      const progress = (step / 4) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
    }

    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    function goBack() {
      showSection('section-token');
      updateProgress(0.5);
    }
  </script>
</body>
</html>

